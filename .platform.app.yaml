# This file describes an application. You can have multiple applications
# in the same project.
#
# See https://docs.platform.sh/user_guide/reference/platform-app-yaml.html

# The name of this app. Must be unique within a project.
name: 'app'

# The runtime the application uses.
type: 'php:7.4'

runtime:
  extensions:
  - sodium
  - redis

variables:
  env:
    COMPOSER_MEMORY_LIMIT: -1
  php:
    memory_limit: 1G

relationships:
    database: "db:mysql"
    rediscache: "cache:redis"
    redissession: "cache:redis"
# The size of the persistent disk of the application (in MB).
disk: 30720

# The 'mounts' describe writable, persistent filesystem mounts in the application. The keys are
# directory paths, relative to the application root. The values are strings such as
# 'shared:files/PATH', where PATH is a relative path under the mount's source directory.
mounts:
  '/web/sites/default/files': 'shared:files/files'
  '/tmp': 'shared:files/tmp'
  '/private': 'shared:files/private'
  '/.drush': 'shared:files/.drush'
  '/drush-backups': 'shared:files/drush-backups'

# Configuration of the build of this application.
build:
  flavor: composer

# The hooks executed at various points in the lifecycle of the application.
hooks:
  # Install recent node.js as well.
  build: |
    curl -sS https://platform.sh/cli/installer | php
    curl -sS https://raw.githubusercontent.com/creationix/nvm/v0.38.0/install.sh | dash -s
    . ~/.environment
    nvm install 16
    nvm alias default 16
    composer build

  # The deploy hook runs after your application has been deployed and started.
  deploy: |
    set -e
    composer site-store-credentials
    composer config-import

# The configuration of app when it is exposed to the web.
web:
  # Specific parameters for different URL prefixes.
  locations:
    '/':
      # The folder from which to serve static assets, for this location.
      #
      # This is a filesystem path, relative to the application root.
      root: 'web'

      # How long to allow static assets from this location to be cached.
      #
      # Can be a time in seconds, or -1 for no caching. Times can be
      # suffixed with "s" (seconds), "m" (minutes), "h" (hours), "d"
      # (days), "w" (weeks), "M" (months, as 30 days) or "y" (years, as
      # 365 days).
      expires: 5m

      # Whether to forward disallowed and missing resources from this
      # location to the application.
      #
      # Can be true, false or a URI path string.
      passthru: '/index.php'

      headers:
        Content-Security-Policy: 'frame-src https://spoken.slq.qld.gov.au.master-7rqtwti-h4cvtpfa7xrio.au.platformsh.site'
        X-Robots-Tag: 'noindex, nofollow'

      # Deny access to static files in this location.
      allow: false

      # Rules for specific URI patterns.
      rules:
        # Allow access to common static files.
        '\.(jpe?g|png|gif|svgz?|css|js|map|ico|bmp|eot|woff2?|otf|ttf)$':
          allow: true
        '^/robots\.txt$':
          allow: true
        '^/sitemap\.xml$':
          allow: true
        '\.html$':
          allow: true
          scripts: true

        # Deny direct access to configuration files.
        '^/sites/sites\.php$':
          scripts: false
        '^/sites/[^/]+/settings.*?\.php$':
          scripts: false

    '/sites/default/files':
      # Allow access to all files in the public files directory.
      allow: true
      expires: 5m
      passthru: '/index.php'
      root: 'web/sites/default/files'

      headers:
        X-Robots-Tag: 'noindex, nofollow'

      # Do not execute PHP scripts.
      scripts: false

      rules:
        # Provide a longer TTL (2 weeks) for aggregated CSS and JS files.
        '^/sites/default/files/(css|js)':
          expires: 2w
        '/(?<path>sites/default/files/styles/.*)$':
          passthru: '/index.php?q=$path'


# The configuration of scheduled execution.
crons:
  drupal:
    spec: '* * * * *'
    cmd: 'cd web; drush core-cron'
  snapshot:
    spec: '0 18 * * *'
    cmd: |
      if [ "$PLATFORM_BRANCH" = master ]; then
        platform snapshot:create --yes --no-wait
      fi
  regen-certs:
    spec: '0 17 1,15 * *'
    cmd: |
      if [ "$PLATFORM_BRANCH" = master ]; then
        platform redeploy --yes --no-wait
      fi
